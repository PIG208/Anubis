
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>Anubis LMS Design Doc - Anubis</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="light" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#anubis-lms-design-doc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Anubis" class="md-header__button md-logo" aria-label="Anubis" data-md-component="logo">
      
  <img src="../img/anubis-icon-1.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Anubis
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Anubis LMS Design Doc
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="light" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="dark" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Anubis" class="md-nav__button md-logo" aria-label="Anubis" data-md-component="logo">
      
  <img src="../img/anubis-icon-1.png" alt="logo">

    </a>
    Anubis
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Anubis LMS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../development_guide/" class="md-nav__link">
        Anubis Development Guide
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Anubis LMS Design Doc
      </a>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="anubis-lms-design-doc">Anubis LMS Design Doc</h1>
<p><img alt="" src="../design-tex/figures/anubis-icon-1.png" /></p>
<blockquote>
<p>Author: <a href="https://github.com/wabscale">John Cunniff</a></p>
<p>Version: v3.1.0</p>
</blockquote>
<p>\pagebreak</p>
<p><img alt="alt anubis-cluster" src="../design-tex/figures/cluster.mmd.png" /></p>
<p>\pagebreak</p>
<h1 id="contents">Contents</h1>
<ul>
<li><a href="#1-overview">1 Overview</a></li>
<li><a href="#11-elevator-pitch">1.1 Elevator Pitch</a></li>
<li><a href="#12-motivations">1.2 Motivations</a></li>
<li><a href="#2-services">2 Services</a></li>
<li><a href="#21-traefik">2.1 Traefik</a></li>
<li><a href="#22-api">2.2 API</a><ul>
<li><a href="#221-zones">2.2.1 Zones</a></li>
<li><a href="#222-responsibilities">2.2.2 Responsibilities</a></li>
<li><a href="#223-sso-authentication">2.2.3 SSO Authentication</a></li>
</ul>
</li>
<li><a href="#23-submission-pipeline">2.3 Submission Pipeline</a><ul>
<li><a href="#231-kube-job">2.3.1 Kube Job</a></li>
<li><a href="#232-submission-state-reporting">2.3.2 Submission State Reporting</a></li>
<li><a href="#233-stages">2.3.3 Stages</a></li>
<li><a href="#clone">Clone</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#test">Test</a></li>
</ul>
</li>
<li><a href="#24-web-frontend">2.4 Web Frontend</a><ul>
<li><a href="#241-autograde-results">2.4.1 Autograde Results</a></li>
</ul>
</li>
<li><a href="#25-anubis-cloud-ide">2.5 Anubis Cloud IDE</a><ul>
<li><a href="#251-ide-frontend">2.5.1 IDE Frontend</a></li>
<li><a href="#252-theia-pod-design">2.5.2 Theia Pod Design</a></li>
<li><a href="#253-reclaiming-theia-resources">2.5.3 Reclaiming Theia Resources</a></li>
<li><a href="#254-management-ide">2.5.4 Management IDE</a></li>
</ul>
</li>
<li><a href="#26-datastores">2.6 Datastores</a><ul>
<li><a href="#261-mariadb">2.6.1 Mariadb</a></li>
<li><a href="#262-elasticsearch">2.6.2 Elasticsearch</a></li>
<li><a href="#263-kibana">2.6.3 Kibana</a></li>
<li><a href="#264-redis--rqworker">2.6.4 Redis + RQWorker</a></li>
<li><a href="#265-redis--flask-caching">2.6.5 Redis + flask-caching</a></li>
</ul>
</li>
<li><a href="#27-logging">2.7 Logging</a><ul>
<li><a href="#271-filebeat">2.7.1 filebeat</a></li>
</ul>
</li>
<li><a href="#3-deployment">3 Deployment</a></li>
<li><a href="#31-kubernetes">3.1 Kubernetes</a><ul>
<li><a href="#311-helm-chart">3.1.1 Helm Chart</a></li>
<li><a href="#312-rolling-updates">3.1.2 Rolling Updates</a></li>
<li><a href="#313-longhorn">3.1.3 Longhorn</a></li>
<li><a href="#314-digital-ocean">3.1.4 Digital Ocean</a></li>
<li><a href="#315-nodes">3.1.5 Nodes</a></li>
<li><a href="#316-networking">3.1.6 Networking</a></li>
</ul>
</li>
<li><a href="#32-github">3.2 Github</a><ul>
<li><a href="#321-organization">3.2.1 Organization</a></li>
<li><a href="#322-classroom">3.2.2 Classroom</a></li>
</ul>
</li>
<li><a href="#4-cli">4 CLI</a></li>
<li><a href="#41-cli-in-management-ide">4.1 CLI in Management IDE</a></li>
<li><a href="#42-cli-usage">4.2 CLI Usage</a></li>
<li><a href="#5-assignments">5 Assignments</a></li>
<li><a href="#51-creating-an-assignment-template-repository">5.1 Creating an Assignment Template Repository</a></li>
<li><a href="#52-creating-assignment-tests">5.2 Creating Assignment Tests</a></li>
<li><a href="#53-writing-tests">5.3 Writing Tests</a></li>
<li><a href="#54-uploading-tests">5.4 Uploading Tests</a></li>
<li><a href="#55-creating-github-classroom-assignment">5.5 Creating Github Classroom Assignment</a></li>
<li><a href="#6-usage-statistics">6 Usage Statistics</a></li>
<li><a href="#61-student-progress">6.1 Student Progress</a></li>
<li><a href="#62-class-progress">6.2 Class Progress</a></li>
<li><a href="#63-public-usage-visuals">6.3 Public Usage Visuals</a></li>
</ul>
<p>\pagebreak</p>
<h2 id="1-overview">1 Overview</h2>
<h3 id="11-elevator-pitch">1.1 Elevator Pitch</h3>
<p>At its core, the Anubis LMS is a tool to give students live feedback from their homework 
assignments while they are working on them and before the deadline. Instead of having students 
submit a patch file or individual files, each student will have their own private repo for 
every assignment. The way students then submit their work is simply by pushing to their repo before 
the deadline. Students submit as many times as they would like before the deadline.</p>
<p>When a student pushes to their assignment repo, a job is launched in the
Anubis cluster. That job will build their code, and run tests on the results.
Students can then use the live feedback to see which areas they need to improve on
before they get their final grades.</p>
<blockquote>
<p>live feedback, before final grades</p>
</blockquote>
<p><img alt="alt autograde-results.png" src="../design-tex/figures/autograde-results.png" /></p>
<p>New in version v2.2.0, there is now the Anubis Cloud IDE. Using some kubernetes magic, we are able to
host <a href="https://theia-ide.org/">theia</a> servers for individual students. These are essentially VSCode instances
that students can access in the browser. What makes these so powerful is that students can access a terminal
and type commands right into a bash shell which will be run in the remote container. With this setup students
have access to a fully insulated and prebuilt linux environment at a click of a button.</p>
<blockquote>
<p>fully insulated and prebuilt linux environment at a click of a button</p>
</blockquote>
<p><img alt="alt theia-fullscreen.png" src="../design-tex/figures/theia-fullscreen.png" /></p>
<h3 id="12-motivations">1.2 Motivations</h3>
<p>The purpose of this paper is to both explain the design, and the features of the Anubis autograder.</p>
<p>One of the main goals for Anubis from the beginning
was to simplify the experience for students. There should not need to
be a learning curve with a learning management system like Anubis just
for students to turn in their homework. <em>Everywhere possible, Anubis
will fill in the blanks.</em> All they need to do is click a button to get an
ide, do their work and check their test feedback if they would like. The
feedback the system gives to students is entirely up to the Professor and TAs.
You could use the Anubis system just for autograding, or just
for the cloud IDEs or both! It is up to you which features of Anubis you
would like to integrate into your curriculum.</p>
<blockquote>
<p>Everywhere possible, Anubis will fill in the blanks</p>
</blockquote>
<p>\pagebreak</p>
<h2 id="2-services">2 Services</h2>
<h3 id="21-traefik">2.1 Traefik</h3>
<p>For our edge router, we use <a href="https:/.traefik.io/">traefik</a>. Traefik will be what actually
listens on the servers external ports. All external traffic will be routed through Traefik. Above all else,
we will be using Traefik's routing features to handle the Ingress of requests.</p>
<p>Traefik lets us do some spicy and powerful stuff. We can route requests to different services based off
predefined rules, and even change requests as they pass through. This makes it so that we can
have both the static store and api on the same domain. The rules are set up such that every request that
starts with a path of <code>/api</code> goes to the api service.</p>
<p>By leveraging these features of Traefik, we can make it appear that the services work different when
being accessed externally.</p>
<blockquote>
<p>One thing to note here is that when being accessed from within the cluster, none of these rules
apply as we would be connecting directly to services.</p>
</blockquote>
<h3 id="22-api">2.2 API</h3>
<p>The API is the backbone of anubis. It is where all the heavy lifting is done. The service relies on both
the <a href="#265-redis--flask-caching">cache</a> and <a href="#261-mariadb">mariadb</a> data stores to maintain state.</p>
<h4 id="221-zones">2.2.1 Zones</h4>
<p>The API is split into two distinct, and uniquely treated zones. There is a <code>public</code> and a <code>admin</code> zone.
All endpoints for Anubis fall within one of these zones.</p>
<p>These zones are simply paths that are treated differently depending on where the request is external. Namely,
for the admin zone external requests will require you to be marked as an admin. By adding this simple level of
authentication, we can lock down a section of the more sensitive API to only those authenticated from the outside.</p>
<h4 id="222-responsibilities">2.2.2 Responsibilities</h4>
<p>The Anubis API is responsible for handling most basic IO, and state managing that happens on the cluster.
Some of this includes:</p>
<ul>
<li>Authenticating users</li>
<li>Providing Class, Assignment, and Submission data to the frontend</li>
<li>Handling github webhooks</li>
<li>Handling reports from the submission pipeline cluster</li>
<li>Handling regrade requests</li>
<li>Initializing new IDE sessions</li>
</ul>
<h4 id="223-sso-authentication">2.2.3 SSO Authentication</h4>
<p>To authenticate with the api, a token is required. The only way to get one of these tokens is through NYU
Single Sign On. By doing this, we are outsourcing our authentication. This saves a whole lot of headaches
while being arguably more secure than if we rolled our own.</p>
<p>All of this is about 20 lines on our end. All that is necessary are some keys from NYU IT.</p>
<h3 id="23-submission-pipeline">2.3 Submission Pipeline</h3>
<h4 id="231-kube-job">2.3.1 Kube Job</h4>
<p>A given submission pipeline is of the form of a Kubernetes <a href="https://kubernetes.io/concepts/workloads/controllers/job/">Job</a>.
These jobs have some built in assurances. A job is configurable to continue to launch new containers if a Pod fails.</p>
<h4 id="232-submission-state-reporting">2.3.2 Submission State Reporting</h4>
<p>At each and every stage of a submission pipeline, the job will report to the api with a state update. This state is
in the form of a string that describes what is currently happening at that moment. This data can then be passed along
to a user that is watching their pipeline be processed live.</p>
<p>Each unique per-assignment pipeline is packaged in the form of a docker image.</p>
<blockquote>
<p>See <a href="#51-creating-a-new-assignment">Creating a new Assignment</a></p>
<p>An error at any stage of the submissions pipeline will result in an error being reported to the API, and
the container exiting.</p>
</blockquote>
<h4 id="233-stages">2.3.3 Stages</h4>
<p>It is important to note that at each stage of the submission pipeline, we will be moving execution back and
forth between two unix users. There will be the entrypoint program managing the container as user <code>anubis</code>. The
<code>anubis</code> user will have much higher privileges than the <code>student</code> user. The <code>student</code> user will be used whenever
executing student code. It will not have any level of access to anything from the <code>anubis</code> user.</p>
<p><img alt="" src="../design-tex/figures/submission-flow.mmd.png" /></p>
<h5 id="clone">Clone</h5>
<p>In this initial stage, we will pull the current repo down from github. After checking out the commit for
the current submission, we will also delete the <code>.git</code> directory as it is not needed. Lastly we will
<code>chown</code> the entire repo as <code>student:student</code>. This will then be the only place in the container that the
student user can read or write to (other than /tmp of course).</p>
<h5 id="build">Build</h5>
<p>At this stage we hand execution off to student code for the first time. We will be building the student
code <em>as the <code>student</code> user</em>. The command for building the container will be specified by on a per-assignment
basis. The stdout of the build will be captured by the <code>anubis</code> user.</p>
<p>Once built, a build report will be sent to the API, along with a state update for the submission. If the
student is on the submission page, then they should be able to see the build info shortly thereafter.</p>
<h5 id="test">Test</h5>
<p>Tests will be defined on a per-assignment basis. Again we are executing student code, as the student user.</p>
<p>After each test, we will return to the entrypoint program as the <code>anubis</code> user. We will then send a report
of the last test before continuing to the next.</p>
<p>Once we reach the last test, we send off a separate notification to the API indicating the completion of
the pipeline. It is at that point that the API marks the submission as processed.</p>
<h3 id="24-web-frontend">2.4 Web Frontend</h3>
<p>The frontend is designed to be a simple reflection of the backend data. Once authenticated, users will
be able to see the classes they are a part of, current and past assignments, and all their submissions.
With few exceptions, the frontend is a near one to one translation of the API's data models. Most pages
will have a corresponding API endpoint. The data shown on that page will be in exactly the form of the
API response.</p>
<p>The submission page will poll for new data if the submission is not marked as processed. As it sees
new data, it will update what is displayed.</p>
<p>Located on the submission page, the purpose of the regrade button is to be a simple and easy way for
users to request regrades. When clicked, the frontend will hit a endpoint for requesting regrades.
If successful, the submission will be reset and re-enqueued in a submission pipeline.</p>
<h4 id="241-autograde-results">2.4.1 Autograde Results</h4>
<p>Getting the autograde results is as easy as searching a name in the autograde results panel. You will
be taken to a page like this where the calculated best submission is shown. The best submission is the
most recent submission that passed the most tests.</p>
<p><img alt="alt autograde-results-2" src="../design-tex/figures/autograde-results-2.png" /></p>
<p>The students see a reduced version of the submission information panel shown to the TAs and professors.
In the admin view, more data is displayed about the student. The students can see the status of the submission,
and the build and test results.</p>
<blockquote>
<p><em>Calculating the best submissions requires heavy IO with the database. For this, the autograde results are
heavily cached. Results are updated hourly.</em></p>
</blockquote>
<p><img alt="alt autograde-results-1" src="../design-tex/figures/autograde-results-1.png" /></p>
<h3 id="25-anubis-cloud-ide">2.5 Anubis Cloud IDE</h3>
<p>One of the more exciting new features is that of the Cloud IDEs. Leveraging some magic that Kubernetes
and containers give us, we can provide a fully insulated linux environment for all ~130 students concurrently.</p>
<p>The <a href="https://theia-ide.org/">Theia IDE</a> is a basically a VSCode webserver. They have base docker images for
specific languages.</p>
<p>Something very special about theia is that we can actually configure custom builds using a package.json. By doing this
we are able to compile in only the plugins we actually need/use. Then because they are docker images, any other software
that is needed for the course can be installed alongside the custom build of theia. Then students are one click away
from having a Cloud IDE that has all the VSCode extensions and other software needed.</p>
<p>With custom builds of theia we can also remove extra things that get installed by default. We can bring the default 
theia-cpp image down from 4GiB to ~1.5GiB. This is still an annoyingly large image, but hey, it's not 4GiB.</p>
<h4 id="251-ide-frontend">2.5.1 IDE Frontend</h4>
<p>Once students have created their repo, they will be able to launch a theia session for a given assignment. At that
time, Anubis clones exactly what is in their github repo into a theia pod.</p>
<p><img alt="Theia Launch Session" src="../design-tex/figures/theia1.png" /></p>
<p>Once their session pod has been allocated, they can click the goto session button. It is at this point
that their requests start to go through the theia proxy services. Assuming all goes well with initializing the session,
and starting the necessary connections, the student will have the access to their very own Cloud IDE.</p>
<p><img alt="Theia Webview" src="../design-tex/figures/theia2.png" /></p>
<p>Something to point out here is that this looks, feels, and acts exactly as VSCode, but it is accessed over the
internet. <a href="https://theia-ide.org/docs/composing_applications/#consuming-vs-code-extensions">Most VSCode extensions will just work on theia.</a></p>
<h4 id="252-theia-pod-design">2.5.2 Theia Pod Design</h4>
<p>The Cloude IDE pod design requires some finesse. There are a couple of things about theia that make it so that
we need to do some rather fancy things in Kubernetes to make the setup work.</p>
<p>Distributing and handling multiple theia severs and concurrent connections is the name of the game here. We
need to be able to have a setup that scales well that is able to handle many users on the system at once.</p>
<p>The main thing that we need to handle is the fact that theia requires a websocket connection between the browser and
theia server instance. When the pods are allocated Anubis records the ClusterIP in the database. Then when we need to
initialize a client connection Anubis uses this saved ClusterIP to forward requests (both http and websockets) to the
correct pod.</p>
<p>These IDE servers are temporary. When the student finishes working (or after a timeout) we reclaim the resources by
deleting the pod and shared volume. Because of this, we needed some form of autosave. Saving is pushing to github.
The issue we need to contend with is automatically committing and pushing to github without exposing a sensitive
password or api token to the users. We handle this by having a second container whose only role is committing and
pushing to github. The credentials live in that container, completely separate and inaccessible to the user who
may be working in the other theia server container. These two containers are connected by a shared volume mounted
at <code>/home/project</code> in both containers. This volume is relatively small (~50MiB).</p>
<p>With this setup, we have autosave running in the background while being completely hidden from the user. When
explaining autosave to students we usually just say "it is witchcraft, just trust that it works".</p>
<p><img alt="Theia Pod Spec" src="../design-tex/figures/theia-pod.mmd.png" /></p>
<p>With these lightweight containerized theia servers, we are able to support significantly more concurrent users than
if we had elected to implement a cloud VM solution. Because Anubis Cloud IDEs do not need to virtualize hardware,
the resources on the system for each user is significantly less. Given the resources that we have on Digital Ocean,
we would be able to have maybe 20-30 concurrent users using cloud virtual machines. With our containerized theia,
we can handle all ~130 students in CS-UY 3224 at the same time with room to breath.</p>
<h4 id="253-reclaiming-theia-resources">2.5.3 Reclaiming Theia Resources</h4>
<p>The Cloud IDE sessions are often forgotten about. Students often create an IDE server work on it for a bit, then forget
about it. Due to this, we have a time to live of 6 hours for each session. A CronJob runs every 5 minutes to look
for and schedule deletes for stale resources. We do provide a button on the Anubis website as a way for students to manually
schedule their session for deletion. Even when we ask students to click this button when they are done, some still do not.
In the following graph we can see an interesting experiment in student behavior. It shows the cumulative duration of
a theia session for the final exam in the Fall 2020 semester for CS-UY 3224. Just about 40% of sessions are destroyed
after hitting the 6-hour timeout.</p>
<p><img alt="Theia Cumulative Duration" src="../design-tex/figures/theia3.png" /></p>
<h4 id="254-management-ide">2.5.4 Management IDE</h4>
<p>Separate from the student xv6 IDE, there is also an admin build of theia that has some extra things. On the assignments
page of the admin panel, any TA or Professor can launch their own Management IDE. In this IDE the assignment-tests
repo is cloned instead of a student assignment repo. It has less networking restrictions, the anubis cli
and even docker running right in the pod. With this TA's and professors can create, modify, and deploy
assignments all from their browser.</p>
<p>Using some very clever authentication mechanics the management IDEs will be initialized with a personal token
that will be used by the CLI within the container. The result of this is that you can then just use the packaged
anubis CLI in the container, and your requests will be authenticated with the API. This authentication model also
enforces course aware permissions. What this means is that you will be able to create and modify assignments for
only the courses that you are a TA or Professor for.</p>
<p><img alt="Management IDE" src="../design-tex/figures/theia4.png" /></p>
<h3 id="26-datastores">2.6 Datastores</h3>
<h4 id="261-mariadb">2.6.1 Mariadb</h4>
<p>Anubis uses the <a href="https://hub.kubeapps.com/charts/bitnami/mariadb">bitnami MariaDB chart</a>. It runs with 3 read-only
replication nodes, along with a main node that does read-write. The underlying MariaDB files are also
backed up with a <a href="https://longhorn.io/">Longhorn</a> persistent volume that has 3x replication in the cluster.
The main volume has daily snapshots. Redundancy is the name of the game here.</p>
<p>The precise data model that we will be using is a simple relational database. From the API, we will interface
with Mariadb via <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>.</p>
<p>Here is an example of a minimal mariadb deployment installed through the bitnami chart. Obviously for production we would
want to change the password from anubis to something stronger.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Create a minimal mariadb deployment in a mariadb namespace. On</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># prod, the mariadb is in a separate namespace, so we do the same</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1"># here.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nb">echo</span> <span class="s1">&#39;Adding mariadb&#39;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># mariadb: ns-mariadb</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1">#   helm upgrade --install mariadb bitnami/mariadb \</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1">#       --set &#39;volumePermissions.enabled=true&#39; \</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="c1">#       --set &#39;auth.username=anubis&#39; \</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="c1">#       --set &#39;auth.database=anubis&#39; \</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="c1">#       --set &quot;auth.password=$(DB_PASS)&quot; \</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1">#       --set &#39;replication.enabled=false&#39; \</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="c1">#       --namespace mariadb</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>make -C k8s/prod mariadb
</code></pre></div>
<h4 id="262-elasticsearch">2.6.2 Elasticsearch</h4>
<p>Anubis uses elasticsearch as a search engine for logging, and event tracking. The
<a href="https://www.elastic.co/">elastic ecosystem</a> has other tools like <a href="#263-kibana">kibana</a>
for visualizing data. Other than the visualization features, elastic allows us to simply start
throwing data at it without defining any meaningful shape. This allows us to just log events and data into
elastic to be retrieved, and visualized later.</p>
<p>The Elasticsearch stack is pretty annoying to manage on its own. Installing through an official chart is
much easier.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Install a minimal elasticsearch deployments</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nb">echo</span> <span class="s1">&#39;Adding elasticsearch + kibana&#39;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># elasticsearch: ns-elastic</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1">#   helm upgrade \</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1">#       --install elasticsearch elastic/elasticsearch \</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="c1">#       --values elastic-values.yaml \</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="c1">#       --version $(ELASTIC_VERSION) \</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="c1">#       --namespace elastic</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>make -C k8s/prod elasticsearch
</code></pre></div>
<h4 id="263-kibana">2.6.3 Kibana</h4>
<p>The Anubis autograder generates a lot of data. We have intense logging, and event tracking on every service.
When something happens on the cluster, it will be indexed into elastic. <a href="https://www.elastic.co/kibana">Kibana</a>
is elastic's data visualization tool. It runs as a website that interfaces with the internal elasticsearch. Through
kibana, we can stream live logs, view event data, and create meaningful visualizations.</p>
<p>The API sees when students start an assignment (create their github repo), and when they are submitting
(pushing to their repo). This data is indexed into elasticsearch, and visualized via kibana. In Anubis version
v1.0.0 we were able to show graphs of when students were starting vs finishing their assignments. To no ones surprise,
the majority of the class was starting very late with a large influx of submissions in the few hours before each
deadline. Furthermore, we can show how long it takes for a student to start their assignment to when they have
their tests pass on average. We can also show which tests were causing students the most trouble.</p>
<p>Here is one such visualization of assignment submissions over time. The peaks are the few days before a due date.</p>
<p><img alt="Submissions Over Time" src="../design-tex/figures/submissions-over-time.png" /></p>
<p>This incredibly precise view into the actual data that can be generated on a platform such as Anubis is
something that sets it apart from its competitors. We can show meaningful statistics to the professors and TAs
on the platform about what went well with their assignment, and where students struggled.</p>
<h4 id="264-redis-rqworker">2.6.4 Redis + RQWorker</h4>
<p>Redis has two purposes in Anubis. It is used by flask-caching to cache some endpoint and function
results. For most all the functions that are heavy on the database, the results are cached for a specified period
of time. The second purpose is as a rpc job broker. We use <a href="https://python-rq.org/">python-rq</a> as it is super
simple and easy to configure and set up. Using rq, we can enqueue functions to be run by a deployment of rpc-worker
pods. Just about every time we need or want to do some work asynchronously, rq is used.</p>
<p>The redis setup needed for anubis is quite minimal. Again we would obviously want to change the password
here in prod.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Install a minimal redis deployment</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nb">echo</span> <span class="s1">&#39;Adding redis&#39;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># redis: ns-anubis</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1">#   helm upgrade \</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="c1">#       --install redis bitnami/redis \</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1">#       --set fullnameOverride=redis \</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1">#       --set global.redis.password=$(REDIS_PASS) \</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1">#       --set architecture=standalone \</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="c1">#       --set master.persistence.enabled=false \</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="c1">#       --namespace anubis</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>make -C k8s/prod redis
</code></pre></div>
<h4 id="265-redis-flask-caching">2.6.5 Redis + flask-caching</h4>
<p>The redis instance is also used for caching function results. Some of the functionalities of Anubis require
a pretty large and time-consuming calculations that would be foolish to not cache. In particular calculating
autograde results and generating visuals are quite computationally intensive (not to mention the strain on the
database). By caching the results (and sometimes preprocessing then caching) the system is significantly
more responsive.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nd">@cache</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">unless</span><span class="o">=</span><span class="n">is_debug</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">def</span> <span class="nf">autograde</span><span class="p">(</span><span class="n">student_id</span><span class="p">,</span> <span class="n">assignment_id</span><span class="p">):</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="sd">    Get the stats for a specific student on a specific assignment.</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="sd">    Pulls all submissions, then finds the most recent one that</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="sd">    has the most tests that passed.</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="sd">    * This function is heavily cached as it is IO intensive on the DB *</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="sd">    :param student_id:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="sd">    :param assignment_id:</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="sd">    :return:</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>
<p>The library we use for this is <a href="https://flask-caching.readthedocs.io/en/latest/index.html">flask-caching</a>.</p>
<h3 id="27-logging">2.7 Logging</h3>
<blockquote>
<p><em>When in doubt, just log it</em></p>
</blockquote>
<h4 id="271-filebeat">2.7.1 filebeat</h4>
<p>Filebeat handles persistent logging. Filebeat is configured to capture all container logs from the 
<code>anubis</code> k8s namespace and index them into elasticsearch. The indexes are then set to maximum limits 
that will recycle space when full.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Install filebeat deployments</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nb">echo</span> <span class="s1">&#39;Adding filebeat&#39;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c1"># filebeat:</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1">#   helm upgrade \</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="c1">#       --install filebeat elastic/filebeat \</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1">#       --values filebeat-values.yaml \</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1">#       --version $(ELASTIC_VERSION) \</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="c1">#       --namespace kube-system</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>make -C k8s/prod filebeat
</code></pre></div>
<p>\pagebreak</p>
<h2 id="3-deployment">3 Deployment</h2>
<h3 id="31-kubernetes">3.1 Kubernetes</h3>
<p>The main goal with moving to Kubernetes from a simple single server docker-compose setup was scalability. We needed
to scale our load horizontally. No longer was adding more RAM and CPU cores to the VM viable. With more users, we
have a greater load. Kubernetes allows us to distribute this load across the servers in the clusters quite easily.</p>
<p>In moving to Kube, we are also now able to make guarantees about availability. In theory, even if sections of
physical servers on the cluster go offline Anubis will still remain available.
<a href="#314-digital-ocean">More on that later...</a></p>
<h4 id="311-helm-chart">3.1.1 Helm Chart</h4>
<p>Anubis itself is packaged as a helm chart. Both mariadb and elasticsearch need to be setup separately. There
are several options for how to deploy anubis that can be specified when running the deploy script at <code>kube/deploy.sh</code>.
Notable options are deploying in debug mode, or restricting access to only the OSIRIS vpn. Options passed
to the deploy script will be then passed to helm.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Deploy in debug mode</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>./k8s/deploy.sh --set <span class="nv">debug</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># Set the initial number of replicas for the api service to 5</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>./k8s/deploy.sh --set api.replicas<span class="o">=</span><span class="m">5</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="c1"># Disable rolling updates</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>./k8s/deploy.sh --set <span class="nv">rollingUpdates</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div>
<p>A full list of options can be found in the <a href="../k8s/chart/values.yaml">values.yaml</a> file.</p>
<h4 id="312-rolling-updates">3.1.2 Rolling Updates</h4>
<p>In the decisions that were made when considering when expanding Anubis, availability was of the most important.
Specifically we needed to move to a platform that would allow us to do <em>zero</em> downtime deploys. Kubernetes has
very powerful rolling update features. We can bring up a new version of the Anubis API, verify that this new
version is healthy, then bring down the old version. All the while, there will be little to no degradation of service.</p>
<p>Of all the features of Kubernetes that Anubis leverages, none are quite as important as rolling updates. The
Anubis API can be updated to a new version with <em>zero</em> downtime. This means we can live patch the Anubis even 
when under load. To hear about one such tricky deploy from the Spring 2021 CU-UY 3224 semester, check out 
<a href="https://anubis.osiris.services/blog/midterm-retro">this blog post</a>.</p>
<h4 id="313-longhorn">3.1.3 Longhorn</h4>
<p>The Kubernetes <a href="https://kubernetes.io/concepts/storage/storage-classes/">StorageClass</a> that Anubis uses is Longhorn. It allows us to have ReadWriteMany volumes
for things like the Cloud IDEs.</p>
<p>All important data is stored on 3x replicated Longhorn StorageVolumes. Those volumes all have at least daily
snapshots taken of them. At any given time, we can reset any stateful service to a previous snapshot from the
last seven days.</p>
<p>For the things that are very important we have daily snapshots, and extra replication. Longhorn makes this
as simple as checking some boxes. You can see here our mariadb master image with triple replication
(two in Brooklyn one in Manhattan), with a 7 day snapshot.</p>
<p><img alt="Longhorn Volume Management" src="../design-tex/figures/longhorn-mariadb.png" /></p>
<h4 id="314-digital-ocean">3.1.4 Digital Ocean</h4>
<p>The official Anubis cluster is hosted on Digital Ocean.
Using their managed Kubernetes solution, the cluster can
balloon in resources when there are many students online.</p>
<p>The main benefits of using a managed cluster instead of
self hosting is ease of mind!</p>
<h5 id="315-nodes">3.1.5 Nodes</h5>
<p>The cluster is comprised of Digital Ocean droplets in their NYC-1 datacenter.
When Kubernetes reports things like memory, cpu or disk pressure the node pools
are automatically scaled up to handle the increased load.</p>
<h5 id="316-networking">3.1.6 Networking</h5>
<p>The Digital Ocean cluster uses a loadbalancer to distribute the networking
load across all existing nodes. Traefik CRD is the reverse proxy that exists on
the cluster to handle the ingress.</p>
<h3 id="32-github">3.2 Github</h3>
<h4 id="321-organization">3.2.1 Organization</h4>
<p>Each class that will need a github organization to put all its repos under. The only members of that organization
should be the professor and TAs.</p>
<p>The organization should be set up to have push event webhooks to anubis. The endpoint the webhook should push
to is <code>https://anubis.osiris.services/api/public/webhook/</code>. That endpoint will be hit when there is a push to a
repo in that organization.</p>
<h4 id="322-classroom">3.2.2 Classroom</h4>
<p><a href="https://classroom.github.com/">Github classroom</a> is used to create, and distribute repos for assignments.
There you can create assignments that will pull from a template repo of your choosing. A link will be generated
that can be distributed to students. When clicked, that link will generate a new repo for the student within the
class organization. As the student is not a part of the organization, they will not be able to see any of the
other student repos (given the assignment was made using a private repo).</p>
<p>The best place to put the template repo is within the class organization as a private repo.</p>
<p>One very important thing to note here is that in order to be able to create private assignment repo's, the
classroom you create must be verified by github. This can take a few weeks, and a professor needs to email
github asking for permission from a .edu email providing their title and whatnot.</p>
<blockquote>
<p>Getting your github classroom / org approved will likely cause delays if not done at least a month
before the semester starts.</p>
</blockquote>
<h2 id="4-cli">4 CLI</h2>
<h3 id="41-cli-in-management-ide">4.1 CLI in Management IDE</h3>
<p>In the Anubis Management IDEs there is an anubis cli installed. When a
Management IDE is started, it is provisioned with the necessary authentication
tokens to communicate with the Anubis API.</p>
<p>The short version of this is that when you use an Anubis Management IDE it
is automatically pointed at the internal API and is authenticated to you.</p>
<h3 id="42-cli-usage">4.2 CLI Usage</h3>
<p>The main purposes of the CLI is for making it a bit easier for admins to make private API calls. In some
cases it will handle the input and output of files.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>jc@aion  master@61e1674  : ~/nyu/os/assignment-tests/spring2021
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>[0] % anubis assignment init new-assignment   
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Creating assignment directory...
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>Initializing the assignment with sample data...
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>You now have an Anubis assignment initialized at new-assignment
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>cd into that directory and run the sync command to upload it to
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>Anubis.
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>cd new-assignment
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>anubis assignment build --push
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>anubis assignment sync
</code></pre></div>
<p>Some use cases would be:
- Adding, Updating and Listing assignment data
- Adding, Updating and Listing class data
- Packaging a new assignment tests, and sending its data off to the cluster</p>
<h2 id="5-assignments">5 Assignments</h2>
<h3 id="51-creating-an-assignment-template-repository">5.1 Creating an Assignment Template Repository</h3>
<p>The first thing we need to do to create a new assignment is to create a template repo
that each student will start with. It is up to you what you would like students to start 
out with. Here is the template from the final exam for OS this semester. This template repo
only contains a hello world c program in the pmerge.c file, and some basic things necessary
to compile the pmerge program in the Makefile. </p>
<p><img alt="alt assignment-template-1" src="../design-tex/figures/assignment-github-template-1.png" /></p>
<p>We can then go into the settings of the repo, and mark it as a template. This is something
necessary for github classroom.</p>
<p><img alt="alt assignment-template-2" src="../design-tex/figures/assignment-github-template-2.png" /></p>
<p>Simply by constraining students to have a specific file name for the program, and a
Makefile to match the submissions are much more uniform. What this means is that
we can have the assignment set up in such a way that everyone's code can be compiled
with the same command. This makes automating the tests much easier. It also can reduce
manual work that the TAs would need to do.</p>
<h3 id="52-creating-assignment-tests">5.2 Creating Assignment Tests</h3>
<p>Using the anubis cli, you can initialize a new assignment using <code>anubis assignment init &lt;name of assignment&gt;</code></p>
<p>The first file you will want to edit is the <code>meta.yml</code> that gets created. This is where things
like the assignment name, and due dates should be defined. There is also a generated <code>unique_code</code>
that anubis uses to identify this assignment. Hold on to this, as we will use it in the next
step.</p>
<p>Here is an example generated <code>meta.yml</code> from the OS final exam this semester. The only fields that
you will need to fill in are the <code>github_classroom_url</code>. This is the URL that is given
to you when you create a github classroom assignment. That link will then be provided as a button
for students to click in the frontend.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nt">assignment</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;final&quot;</span><span class="w"></span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;CS-UY</span><span class="nv"> </span><span class="s">3224&quot;</span><span class="w"></span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="nt">hidden</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="c1"># Optionally specify the github classroom link</span><span class="w"></span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span><span class="c1"># for students to get their repo.</span><span class="w"></span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">  </span><span class="nt">github_classroom_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">  </span><span class="c1"># Don&#39;t change these!</span><span class="w"></span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">  </span><span class="nt">unique_code</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;839f70b2&quot;</span><span class="w"></span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span><span class="nt">pipeline_image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;registry.digitalocean.com/anubis/assignment/839f70b2&quot;</span><span class="w"></span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">  </span><span class="c1"># Specify the important dates here (remember these are America/New_York)</span><span class="w"></span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">  </span><span class="nt">date</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-05-17</span><span class="nv"> </span><span class="s">06:00:00&quot;</span><span class="w"></span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="nt">due</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-05-19</span><span class="nv"> </span><span class="s">06:00:00&quot;</span><span class="w"></span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="nt">grace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-05-19</span><span class="nv"> </span><span class="s">06:30:00&quot;</span><span class="w"></span>
</code></pre></div>
<h3 id="53-writing-tests">5.3 Writing Tests</h3>
<p>All the files to build and run a complete anubis pipeline image will be dropped into the new directory.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>new-assignment
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>|- assignment.py
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>|- Dockerfile
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>|- meta.yml
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>|- pipeline.py
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>|- test.sh
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>`- utils.py
</code></pre></div>
<p>The only thing you will ever need to edit is <code>assignment.py</code>. This is where you define your build and
test code. Just like all the other cool libraries out there, the anubis pipeline works through hooking
functions. Here is a minimal example of an assignment.py that will build and run a single simple test.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">register_test</span><span class="p">,</span> <span class="n">register_build</span><span class="p">,</span> <span class="n">exec_as_student</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="n">TestResult</span><span class="p">,</span> <span class="n">BuildResult</span><span class="p">,</span> <span class="n">Panic</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">,</span> 
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">xv6_run</span><span class="p">,</span> <span class="n">did_xv6_crash</span><span class="p">,</span> 
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">verify_expected</span><span class="p">,</span> <span class="n">search_lines</span><span class="p">,</span> <span class="n">test_lines</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="nd">@register_build</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_result</span><span class="p">:</span> <span class="n">BuildResult</span><span class="p">):</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">stdout</span><span class="p">,</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">exec_as_student</span><span class="p">(</span><span class="s1">&#39;make xv6.img fs.img&#39;</span><span class="p">)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="n">build_result</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">build_result</span><span class="o">.</span><span class="n">passed</span> <span class="o">=</span> <span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="nd">@register_test</span><span class="p">(</span><span class="s1">&#39;test echo&#39;</span><span class="p">)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="n">test_result</span><span class="p">:</span> <span class="n">TestResult</span><span class="p">):</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="n">test_result</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="s2">&quot;Testing echo 123</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="c1"># Start xv6 and run command</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    <span class="n">stdout_lines</span> <span class="o">=</span> <span class="n">xv6_run</span><span class="p">(</span><span class="s2">&quot;echo 123&quot;</span><span class="p">,</span> <span class="n">test_result</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="c1"># Run echo 123 as student user and capture output lines</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="n">expected_raw</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">exec_as_student</span><span class="p">(</span><span class="s1">&#39;echo 123&#39;</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="n">expected</span> <span class="o">=</span> <span class="n">expected_raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    <span class="c1"># Attempt to detect crash</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>    <span class="k">if</span> <span class="n">did_xv6_crash</span><span class="p">(</span><span class="n">stdout_lines</span><span class="p">,</span> <span class="n">test_result</span><span class="p">):</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>        <span class="k">return</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>    <span class="c1"># Test to see if the expected result was found</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>    <span class="n">verify_expected</span><span class="p">(</span><span class="n">stdout_lines</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">test_result</span><span class="p">)</span>
</code></pre></div>
<p>There are a couple functions to point out here. The <code>register_build</code> and <code>register_test</code> 
decorators are how you tell anubis about your build and test. The <code>exec_as_student</code> is how 
you should call any and all student code. It lowers the privileges way down so that even 
if the student pushes something malicious, they are still low privileged enough where they 
can not do much. It also adds timeouts to their commands. Boxing student code in like this
is absolutely essential. Do not underestimate the creative and surprising ways students will
find to break things.</p>
<p>Each test is passed a <code>test_result</code> object. This object has 3 fields. All you need to do
is set the fields on the <code>test_result</code> object. The results will then be reported to the
anubis api, and then to the student.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span> <span class="nc">TestResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>        <span class="c1"># The standard out for the students tests. You can </span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>        <span class="c1"># add extra text in this field as needed.</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        <span class="c1"># The message is an optional parameter that will </span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>        <span class="c1"># insert a short message in bold above the standard </span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="c1"># out on the website frontend.  </span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="c1"># Passed should be a boolean value. True if the test</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="c1"># passed, and False if it did not.</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">passed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<p>The functions <code>run_xv6</code> and <code>did_xv6_crash</code> are very specific to the Intro to OS needs.
There are also some general functions that are just as helpful.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">def</span> <span class="nf">exec_as_student</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="sd">    Run a command as the student. Any and all times that student</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="sd">    code is run, it should be done through this function. Any other</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="sd">    way would be incredibly insecure.</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="sd">    :param cmd: Command to run</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="sd">    :param timeout: Timeout for command</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="sd">    :return: bytes output, int return code</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="k">def</span> <span class="nf">verify_expected</span><span class="p">(</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="n">stdout_lines</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>    <span class="n">expected_lines</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="n">test_result</span><span class="p">:</span> <span class="n">TestResult</span><span class="p">,</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>    <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="p">):</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="sd">    Check to lists of strings for quality. Will strip off whitespace from each line</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="sd">    before checking for equality. The stdout_lines should be from the student code.</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="sd">    The expected_lines should then be whichever lines are expected for this test.</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="sd">    * The fields on the test_result object will be set automatically based on if the</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="sd">    expected output was found. *</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="sd">    :param stdout_lines: students lines as a list of strings</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="sd">    :param expected_lines: expected lines as a list of strings</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="sd">    :param test_result: TestResult object for this test</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="sd">    :param case_sensitive: boolean to indicate if the comparison should be case sensitive</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="sd">    :param search: boolean to indicate if the stdout should be searched instead of</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="sd">                   directly compared for equality</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="sd">    :return:</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="k">def</span> <span class="nf">test_lines</span><span class="p">(</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>        <span class="n">stdout_lines</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>        <span class="n">expected_lines</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>        <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="sd">    Test lines for exact equality. Whitespace will be stripped off each line automatically.</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a><span class="sd">    * Optionally specify if the equality comparison should be case sensitive *</span>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a><span class="sd">    &gt;&gt;&gt; test_lines([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;], [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) -&gt; True</span>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a><span class="sd">    &gt;&gt;&gt; test_lines([&#39;a&#39;, &#39;debugging&#39;, &#39;b&#39;, &#39;c&#39;], [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) -&gt; False</span>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a><span class="sd">    &gt;&gt;&gt; test_lines([&#39;a&#39;, &#39;b&#39;],      [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) -&gt; False</span>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a><span class="sd">    :param stdout_lines: students standard out lines as a list of strings</span>
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a><span class="sd">    :param expected_lines: expected lines as a list of strings</span>
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a><span class="sd">    :param case_sensitive: optional boolean to indicate if comparison should be case sensitive</span>
<a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a><span class="sd">    :return: True if exact match was found, False otherwise</span>
<a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>
<a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>
<a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a><span class="k">def</span> <span class="nf">search_lines</span><span class="p">(</span>
<a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>        <span class="n">stdout_lines</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>        <span class="n">expected_lines</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>        <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a><span class="sd">    Search lines for expected lines. This will return true if all expected lines are in the</span>
<a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a><span class="sd">    student standard out lines in order. There can be interruptions in the student standard out.</span>
<a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a><span class="sd">    This function has the advantage of allowing students to still print out debugging lines</span>
<a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a><span class="sd">    while their output is still accurately checked for  the expected result.</span>
<a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a>
<a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a><span class="sd">    &gt;&gt;&gt; search_lines([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;], [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) -&gt; True</span>
<a id="__codelineno-11-71" name="__codelineno-11-71" href="#__codelineno-11-71"></a><span class="sd">    &gt;&gt;&gt; search_lines([&#39;a&#39;, &#39;debugging&#39;, &#39;b&#39;, &#39;c&#39;], [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) -&gt; True</span>
<a id="__codelineno-11-72" name="__codelineno-11-72" href="#__codelineno-11-72"></a><span class="sd">    &gt;&gt;&gt; search_lines([&#39;a&#39;, &#39;b&#39;],      [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) -&gt; False</span>
<a id="__codelineno-11-73" name="__codelineno-11-73" href="#__codelineno-11-73"></a>
<a id="__codelineno-11-74" name="__codelineno-11-74" href="#__codelineno-11-74"></a><span class="sd">    * Optionally specify if the equality comparison should be case sensitive *</span>
<a id="__codelineno-11-75" name="__codelineno-11-75" href="#__codelineno-11-75"></a>
<a id="__codelineno-11-76" name="__codelineno-11-76" href="#__codelineno-11-76"></a><span class="sd">    :param stdout_lines:</span>
<a id="__codelineno-11-77" name="__codelineno-11-77" href="#__codelineno-11-77"></a><span class="sd">    :param expected_lines:</span>
<a id="__codelineno-11-78" name="__codelineno-11-78" href="#__codelineno-11-78"></a><span class="sd">    :param case_sensitive:</span>
<a id="__codelineno-11-79" name="__codelineno-11-79" href="#__codelineno-11-79"></a><span class="sd">    :return:</span>
<a id="__codelineno-11-80" name="__codelineno-11-80" href="#__codelineno-11-80"></a><span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>
<h3 id="54-uploading-tests">5.4 Uploading Tests</h3>
<p>Now you have your tests. That's great. The next thing you need to do is push the image to the docker registry and
upload the assignment data to anubis. This is as simple as running two commands:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># sends assignment metadata to anubis api</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>anubis assignment sync          
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># builds then pushes the assignment</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="c1"># pipeline image to the registry</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>anubis assignment build --push
</code></pre></div>
<h3 id="55-creating-github-classroom-assignment">5.5 Creating Github Classroom Assignment</h3>
<p>Go to github classroom, and select the button to create a new assignment. You can name 
the assignment anything you would like. The most important
part of the process when creating a github classroom assignment is making sure to fill
in the <code>Custom repository Prefix</code> in the first step. The custom repo prefix needs
to end with a <code>-</code> followed by the <code>unique_code</code> we we given in the 
<a href="#52-creating-assignment-tests">generated meta.yml</a>. Your custom prefix should look something
like this:</p>
<p><img alt="alt github-classroom-1" src="../design-tex/figures/github-classroom-1.png" /></p>
<blockquote>
<p><em>The purpose of this custom prefix is to make sure that the <code>unique_code</code> will be in the
repo title for each student. Anubis needs this unique code to be available in order to 
figure out which assignment each repo belongs to.</em> </p>
</blockquote>
<p>At the end of this process github classroom will provide an assignment invitation link.
You should take this link and put it in your <code>meta.yml</code> under the <code>github_classroom_url</code>
field. </p>
<h2 id="6-usage-statistics">6 Usage Statistics</h2>
<p>Simply by placing timestamps on thing that are already tracked like submissions
and the test results for submissions, we can start to both ask and
answer some interesting questions about how well students are understanding
certain topics.</p>
<h3 id="61-student-progress">6.1 Student Progress</h3>
<p>Given the structure of Anubis assignments, coupled with the Anubis Cloud IDEs
we can track and measure each student's progress through an assignment. We can 
track and measure when students start and finish their assignments, and how long 
it takes them to pass specific tests. In the autograde results panel, a "visual 
history" is generated for each student. It shows when students started their 
assignment, then for each submission if their build passed or failed and how many
tests passed. If they used the Anubis Cloud IDEs as most students do choose to, then
the graph generated shows a near minute by minute representation of which challenges
they faced and how long it took for them to overcome them.</p>
<p><img alt="alt student-history" src="../design-tex/figures/student-assignment-visual-history-1.png" /></p>
<blockquote>
<p>This example shows the build as the green line, and the assignment tests as the blue line.
We can see that this student spent a good deal of time on the first day just getting their
tests to pass, only to revisit their work the next day probably to clean up their submission.</p>
</blockquote>
<h3 id="62-class-progress">6.2 Class Progress</h3>
<p>Then more generally Anubis can represent how the class as a whole did on the assignment. One 
of the core visuals generated is what we call the "summary sundial". In this sundial, we can
show a quick view of how well the class did on the assignment.</p>
<p><img alt="alt sundial-1" src="../design-tex/figures/sundial-1.png" /></p>
<p>The sundial shows how many students submitted work, and which test had the most cases pass.
This assignment had 5 autograde tests. The inner purple radial represents all the students that
submitted work for this assignment. Then each of the outer 5 blue radials represents an assignment
test. Then the most outside layer shows in green and red how many students passed, and failed 
that test. We can hover over an element to get a more detailed look.</p>
<p><img alt="alt sundial-2" src="../design-tex/figures/sundial-2.png" /></p>
<p>From the detail tree at the bottom, we can see that of the 123 students whose builds passed,
90 passed the <code>cat input.txt | pmerge</code> test.</p>
<p><img alt="alt sundial-3" src="../design-tex/figures/sundial-3.png" /></p>
<p>Taking a look at another test, we can see that more students failed this test than passed.
This test is the same as the previous one except it gives the student program a much larger 
file. From this we can see that we need to review how to buffer long input files.</p>
<h3 id="63-public-usage-visuals">6.3 Public Usage Visuals</h3>
<p>We provide public usage visuals that are generated every few minutes. These visuals 
show a near live view of how many submissions, and IDEs are active for each assignment 
on the platform.</p>
<p><img alt="alt public-usage-1" src="../design-tex/figures/public-usage-1.png" /></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../development_guide/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Anubis Development Guide" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Anubis Development Guide
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>