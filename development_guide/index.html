
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>Anubis Development Guide - Anubis</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="light" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#anubis-development-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Anubis" class="md-header__button md-logo" aria-label="Anubis" data-md-component="logo">
      
  <img src="../img/anubis-icon-1.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Anubis
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Anubis Development Guide
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="light" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="dark" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Anubis" class="md-nav__button md-logo" aria-label="Anubis" data-md-component="logo">
      
  <img src="../img/anubis-icon-1.png" alt="logo">

    </a>
    Anubis
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Anubis LMS
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Anubis Development Guide
      </a>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../old-anubis-design/" class="md-nav__link">
        Anubis LMS Design Doc
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="anubis-development-guide">Anubis Development Guide</h1>
<p align="center">
  <a href="https://anubis.osiris.services/">
    <img
      alt="Anubis"
      src="https://raw.githubusercontent.com/GusSand/Anubis/master/docs/design-tex/figures/anubis-icon-1.png"
      width="400"
    />
  </a>
</p>

<h1 id="table-of-contents">Table of contents</h1>
<ul>
<li><a href="#project-layout">Project layout</a></li>
<li><a href="#foreword">Foreword</a></li>
<li><a href="#startup-links">startup links</a></li>
<li><a href="#mindebug-environment">mindebug environment</a></li>
<li><a href="#debug-environment">debug environment</a></li>
<li><a href="#mkdebug-environment">mkdebug environment</a></li>
<li><a href="#further">Further</a></li>
</ul>
<h2 id="project-layout">Project layout</h2>
<ul>
<li><a href="../api">api</a> is where the flask api lives</li>
<li><a href="../web">web</a> is where the reactjs website lives</li>
<li><a href="../theia">theia</a> is where the different components that make up the Anubis Cloud IDEs live</li>
<li><a href="../k8s">k8s</a> is where the kubernetes definitions for things live. This includes the 
  Anubis helm chart, and prod provisioning scripts.</li>
</ul>
<h2 id="foreword">Foreword</h2>
<p>Anubis is a very big system. For this reason there are three separate debug environments. Each one
is a little closer to fully simulating prod. There are certain things that can only be done in 
one development environment. The three environments are called:</p>
<ol>
<li>mindebug - natively run api and website</li>
<li>debug - launch services through docker-compose in containers  </li>
<li>mkdebug - launch services in minikube cluster</li>
</ol>
<p>Each of these environments are meant to be launched from the top level Makefile. At the end of
starting each environment, a list of what we call <a href="#startup-links">startup links</a> will be printed.</p>
<h2 id="startup-links">startup links</h2>
<p>The startup links are meant to make seeding the database, and getting logged in while debugging fast 
and easy. The links do not change between debug environments (except with mindebug being on 
port 3000).</p>
<p>The startup links for the <code>debug</code> and <code>mkdebug</code> are:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>seed: http://localhost/api/admin/seed/
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>auth: http://localhost/api/admin/auth/token/superuser
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>auth: http://localhost/api/admin/auth/token/professor
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>auth: http://localhost/api/admin/auth/token/ta
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>auth: http://localhost/api/admin/auth/token/student
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>site: http://localhost/
</code></pre></div>
<p>The startup links for <code>mindebug</code> are:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>seed: http://localhost:3000/api/admin/seed/
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>auth: http://localhost:3000/api/admin/auth/token/superuser
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>auth: http://localhost:3000/api/admin/auth/token/professor
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>auth: http://localhost:3000/api/admin/auth/token/ta
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>auth: http://localhost:3000/api/admin/auth/token/student
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>site: http://localhost:3000/
</code></pre></div>
<p>When you click on the seed link, the api will run a <a href="https://github.com/GusSand/Anubis/blob/master/api/anubis/rpc/seed.py#L33">seed function</a>
that will initialize the database with some generated assignments, submissions and users of different permission levels.</p>
<p>There are 4 main permission levels (which are course specific). The seed endpoint will create a user for
the generated course at each permission level. Clicking on any of the auth links that are printed will set
a token cookie logging you in as that user. If you are having issues logging in with the auth links,
you should clear your cookies and try again. The seed also may take a couple of seconds to run. If you
click the seed link, then an auth link before the seed has had a chance to create that user it may say 
that the user does not exist.</p>
<p>The last site link is just for convenience, so you can open a new tab with the website after clicking your other
startup links.</p>
<p>So to recap, after the debug services have started you can use the startup links to quickly seed (or re-seed) data and
log in as a user of a specific permission level. The order of links that the maintainers use is first the seed, then
the superuser link, then the site link. That will initialize the database with generated data, log us in as a superuser,
then open the website.</p>
<h2 id="mindebug-environment">mindebug environment</h2>
<p>This is what will work for most people. If you are on OSX, Windows or have a potato computer you should start with this.
The other debug environments use lots of docker containers, which just do not work well on OSX or
Windows. This debug environment uses the least amount of resources by far. There are several places 
that this environment differs from prod (we will get into that later).</p>
<p>You will need these things installed:</p>
<ul>
<li>make</li>
<li>python 3.7 or above</li>
<li>virtualenv </li>
<li>nodejs </li>
<li>yarn</li>
</ul>
<p>To start off <code>mindebug</code> first run this at the top of the repo:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>make mindebug
</code></pre></div>
<p>This command will initialize the python virtual environment for the api and the node_modules for the web. It
will then print out the mindebug startup links.
The api and web servers will be then (hopefully) start.</p>
<p>Things that will not work with <code>mindebug</code> are:</p>
<ul>
<li>Anything that interacts with the kubernetes API</li>
<li>Cloud IDEs</li>
<li>Submission pipelines</li>
<li>Most everything that involves RPC</li>
<li>Database migrations (we skirt mariadb migrations to use sqlite instead)</li>
<li>Things that use libmagic (file upload specifically use this)</li>
</ul>
<p>One last thing to note with the mindebug environment is that rpc job will be called synchronously where normally they
would be called asynchronously. This is because the library we use for rpc <a href="https://python-rq.org/">python-rq</a> requires
a redis backend. Since there is no such service in the mindebug environment, rpc calls are called when they would 
normally be enqueued.</p>
<p>To run the api tests under while running mindebug, you will want to run the <code>mintest.sh</code> script at <code>api/tests/mindebug.sh</code>.</p>
<p>Now you can hack Anubis</p>
<h2 id="debug-environment">debug environment</h2>
<p>If you are on linux and have at least 2-6 GiB of memory to spare, this option is probably best for you. This is much closer
to simulating prod than the mindebug configuration. This is the debug configuration that most of Anubis has been written
with.</p>
<p>You will need these things installed:</p>
<ul>
<li>docker</li>
<li>docker-compose 3.7 or above</li>
</ul>
<p>All you need to do to start all the debug services is run this at the top of the repo:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># This will start the flask api, web server, rpc workers, traefik, mariadb and redis</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>make debug
</code></pre></div>
<p>In this setup we run the api and web in DEBUG mode. The containers that are launched will also have the proper
places in the repo mounted. So changes to code will be picked up and services will restart.</p>
<p>Things that will not work with <code>debug</code> are:</p>
<ul>
<li>Anything that interacts with the kubernetes API</li>
<li>Cloud IDEs</li>
<li>Submission pipelines</li>
</ul>
<h2 id="mkdebug-environment">mkdebug environment</h2>
<p>If you have 4-8 GiB of memory to spare, and want to specifically develop the Cloud IDEs or Submission pipelines then
this is the environment for you. This environment is as close to prod as you can get. mkdebug is really only meant for
developing things that directly interact with the kubernetes api. Unlike the more simple docker-compose setup in the 
debug environment, there is no live edit updating here. You will need to rebuild and restart services when you have 
a change.</p>
<p>You will need these things installed:</p>
<ul>
<li>docker</li>
<li>minikube</li>
<li>helm 3</li>
<li>kubectl</li>
</ul>
<p>All you need to do to start all the debug services is run this at the top of the repo:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># This will provision a new minikube cluster with Anubis</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1"># !Warning! this will delete any existing minikube cluster</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>make mkdebug
</code></pre></div>
<p>There is also a special script that is called when provisioning the minikube cluster. The purpose of it
is to place any kubernetes secret create commands that you may need. Place that script at <code>k8s/debug/init-secrets.sh</code>.
The file will be gitignored, but be extra sure you do not commit it on accident.</p>
<p>The startup links for the minikube debug environment work exactly the same as with the debug and mindebug environments.
When you have a change that you want to push to the minikube cluster you can run the <code>./k8s/debug/restart.sh</code> script. It
will rebuild and restart common services (like api, web, rpc workers). You can also get a kubernetes dashboard with
<code>minikube dashboard</code>.</p>
<p>The script that provisions minikube will also set the cluster resources to half your machines cpu and memory resources.</p>
<h2 id="further">Further</h2>
<ul>
<li>Checkout the <a href="https://github.com/GusSand/Anubis/projects/1">project board</a> to see what you can 
contribute</li>
<li>Checkout the <a href="./README.md">design doc</a> to see a detailed explanation of the internals of Anubis</li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Anubis LMS" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Anubis LMS
            </div>
          </div>
        </a>
      
      
        
        <a href="../old-anubis-design/" class="md-footer__link md-footer__link--next" aria-label="Next: Anubis LMS Design Doc" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Anubis LMS Design Doc
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>